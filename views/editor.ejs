<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H3LPeR</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#569cd6">
  <meta name="description" content="Personal journal with calendar, tasks, and email integration">
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="H3LPeR">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/helper-tabs.css">
  <!-- CodeMirror 5 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/mode/overlay.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gfm/gfm.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/edit/continuelist.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/addon/fold/foldgutter.min.css">
  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>
<body>
  <!-- Google Auth Status Banner -->
  <div id="google-auth-banner" class="auth-banner hidden">
    <span id="auth-banner-message"></span>
    <button onclick="window.location.href='/google-setup'" class="btn btn-secondary btn-sm">Re-authenticate</button>
    <button onclick="document.getElementById('google-auth-banner').classList.add('hidden')" class="btn btn-icon btn-sm">&times;</button>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav">
    <button class="tab-btn" data-tab="calendar" id="calendar-tab-btn">Calendar</button>
    <button class="tab-btn" data-tab="writer">H3LPeR</button>
    <button class="tab-btn active" data-tab="weather" id="weather-tab-btn">Weather</button>
    <button class="tab-btn" data-tab="news" id="news-tab-btn">News</button>
    <button class="tab-btn" data-tab="research" id="research-tab-btn">Research</button>
    <div class="tab-nav-spacer"></div>
    <a href="https://mail.google.com" target="_blank" class="btn btn-link btn-sm email-indicator" id="email-indicator" title="Gmail">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
        <polyline points="22,6 12,13 2,6"></polyline>
      </svg>
      <span id="unread-count" class="unread-badge hidden">0</span>
    </a>
    <a href="/google-setup" class="btn btn-link btn-sm" title="Google Integration">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
    </a>
    <button class="btn btn-link btn-sm" id="help-btn" title="Help & About">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    </button>
  </nav>

  <!-- Writer Tab -->
  <div class="tab-content" id="writer-tab">
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="app-sidebar">
      <div class="sidebar-icon-rail" id="icon-rail">
        <div class="icon-rail-top" id="icon-rail-top"></div>
        <div class="icon-rail-bottom" id="icon-rail-bottom">
          <button class="icon-rail-btn" id="sidebar-new-file-btn" title="New File">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </button>
          <button class="icon-rail-btn" id="sidebar-collapse-btn" title="Collapse Sidebar (Ctrl+B)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="sidebar-panel-area" id="sidebar-panels">
        <div class="sidebar-panel-header" id="sidebar-panel-header">
          <span class="sidebar-panel-title" id="sidebar-panel-title"></span>
        </div>
        <div class="sidebar-panel-container" id="sidebar-panel-container"></div>
        <div class="sidebar-footer">
          <div id="sync-status" class="sync-status">
            <span class="sync-indicator"></span>
            <span id="sync-text">Syncing...</span>
          </div>
          <a href="/api/logout" class="btn btn-link">Logout</a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Editor Header -->
      <header class="editor-header">
        <div class="file-info">
          <button id="mobile-sidebar-toggle" class="btn btn-icon mobile-only" title="Toggle Sidebar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <div class="file-menu-container">
            <button id="file-menu-btn" class="btn btn-icon" onclick="toggleFileMenu()" title="File menu">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
            </button>
            <div id="file-menu" class="file-menu hidden">
              <div class="file-menu-item" id="file-menu-save-as" onclick="saveBufferAsFile()">Save As...</div>
              <div class="file-menu-item" id="file-menu-rename" onclick="renameCurrentFile()">Rename</div>
              <div class="file-menu-item danger" id="file-menu-delete" onclick="deleteCurrentFile()">Delete</div>
            </div>
          </div>
          <div class="file-path" id="current-file-path">
            <%= currentFile ? currentFile.path : 'Select a file' %>
          </div>
        </div>
        <div class="editor-actions">
          <button id="nav-back-btn" class="btn btn-icon" onclick="navigateBack()" title="Go back" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <button id="nav-forward-btn" class="btn btn-icon" onclick="navigateForward()" title="Go forward" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <div class="editor-separator"></div>
          <button id="undo-btn" class="btn btn-icon" onclick="editorUndo()" title="Undo (Ctrl+Z)" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="1 4 1 10 7 10"></polyline>
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
          </button>
          <button id="redo-btn" class="btn btn-icon" onclick="editorRedo()" title="Redo (Ctrl+Shift+Z)" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </button>
          <div class="editor-separator"></div>
          <button id="add-agenda-btn" class="btn btn-secondary" onclick="addTodayAgendaFromCalendar()" title="Add today's agenda">Add Agenda</button>
          <span id="save-status"></span>
        </div>
      </header>

      <div class="buffer-tabs" id="buffer-tabs"></div>

      <!-- Editor -->
      <div class="editor-container">
        <div id="editor"></div>
      </div>

      <!-- Backlinks Panel (collapsible) -->
      <div class="backlinks-panel collapsed" id="backlinks-panel">
        <div class="backlinks-header" onclick="toggleBacklinks()">
          <span class="backlinks-toggle">‚ñ∂</span>
          <h3>Backlinks</h3>
          <span class="backlinks-count" id="backlinks-count"></span>
        </div>
        <div class="backlinks-content" id="backlinks-list"></div>
      </div>
    </main>

    <!-- Quick Switcher Modal -->
    <div id="quick-switcher" class="modal hidden">
      <div class="modal-content">
        <input type="text" id="switcher-input" placeholder="Type to search files...">
        <div id="switcher-results"></div>
      </div>
    </div>

    <!-- New File Modal -->
    <div id="new-file-modal" class="modal hidden">
      <div class="modal-content">
        <h3>New File</h3>
        <input type="text" id="new-file-name" placeholder="filename.md">
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeNewFileModal()">Cancel</button>
          <button class="btn btn-primary" onclick="createNewFile()">Create</button>
        </div>
      </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflict-modal" class="modal hidden">
      <div class="modal-content conflict-modal">
        <h3>‚ö†Ô∏è Sync Conflict Detected</h3>
        <p>This file was modified both locally and on the server. Choose which version to keep:</p>
        <div class="conflict-versions">
          <div class="conflict-version">
            <h4>Your Local Version</h4>
            <pre id="conflict-local"></pre>
            <button class="btn btn-primary" onclick="resolveConflict('local')">Keep Local</button>
          </div>
          <div class="conflict-version">
            <h4>Server Version</h4>
            <pre id="conflict-server"></pre>
            <button class="btn btn-primary" onclick="resolveConflict('server')">Keep Server</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <!-- End Writer Tab -->

  <!-- Calendar Tab -->
  <div class="tab-content" id="calendar-tab">
    <div class="calendar-tab-container">
      <div class="calendar-tab-header">
        <h2>Calendar & Tasks</h2>
        <div class="calendar-controls">
          <button id="refresh-calendar" class="btn btn-secondary" title="Refresh">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Refresh
          </button>
          <button id="calendar-settings" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m0-12l4 4m-4 4l4 4m-8-8l-4-4m4 4l-4 4"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="calendar-tab-main">
        <aside class="calendar-sidebar">
          <div id="calendar-selector-panel">
            <h3>My Calendars</h3>
            <div id="calendar-list" class="calendar-list"></div>
          </div>
          <div id="tasks-panel" class="tasks-panel"></div>
        </aside>
        <div id="calendar-view" class="calendar-view"></div>
      </div>
    </div>
  </div>
  <!-- End Calendar Tab -->

  <!-- Weather Tab -->
  <div class="tab-content active" id="weather-tab">
    <div class="helper-tab-container">
      <div class="helper-tab-header">
        <h2>Weather & Space Weather</h2>
        <div class="helper-controls">
          <button id="refresh-weather" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>
      <div class="helper-tab-content" id="weather-content">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>
  <!-- End Weather Tab -->

  <!-- News Tab -->
  <div class="tab-content" id="news-tab">
    <div class="helper-tab-container">
      <div class="helper-tab-header">
        <h2>News & Stories</h2>
        <div class="helper-controls">
          <button id="refresh-news" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>
      <div class="helper-tab-content" id="news-stories">
        <div class="loading-spinner"></div>
      </div>
      <div class="stocks-ticker" id="stocks-ticker"></div>
    </div>
  </div>
  <!-- End News Tab -->

  <!-- Research Tab -->
  <div class="tab-content" id="research-tab">
    <div class="helper-tab-container">
      <div class="helper-tab-header">
        <h2>Research Papers</h2>
        <div class="helper-controls">
          <select id="research-date">
            <option value="">Today</option>
          </select>
        </div>
      </div>
      <div class="helper-tab-content" id="research-content">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>
  <!-- End Research Tab -->

  <!-- Help Modal -->
  <div id="help-modal" class="modal hidden">
    <div class="modal-content help-modal-content">
      <div class="modal-header">
        <h2>About H3LPeR</h2>
        <button class="modal-close" onclick="document.getElementById('help-modal').classList.add('hidden')">&times;</button>
      </div>
      <div class="modal-body">
        <p class="modal-intro">
          An Obsidian-like web journal with real-time data integrations, PWA support, and intelligent content processing.
        </p>
        
        <h3>Why H3LPeR Over Static Markdown Files?</h3>
        <p>H3LPeR offers significant advantages over generating static .md files once daily:</p>
        
        <div class="modal-section">
          <h4>üîÑ Real-Time, On-Demand Updates</h4>
          <ul>
            <li><strong>Live Data Refresh</strong>: Click to get fresh weather, news, research instantly</li>
            <li><strong>Auto-Updates</strong>: News refreshes every 6 hours, research every 24 hours</li>
            <li><strong>Calendar Integration</strong>: Google Calendar events update in real-time</li>
            <li><strong>Email Notifications</strong>: Live unread count from Gmail</li>
          </ul>
        </div>

        <div class="modal-section">
          <h4>ü§ñ Intelligent Content Processing</h4>
          <ul>
            <li><strong>AI News Clustering</strong>: Groups similar stories with OpenAI embeddings</li>
            <li><strong>Delta Processing</strong>: Only processes new articles, saving API costs</li>
            <li><strong>Research Ranking</strong>: Claude AI ranks arXiv papers by relevance</li>
            <li><strong>Smart Updates</strong>: Continuous processing throughout the day</li>
          </ul>
        </div>

        <div class="modal-section">
          <h4>üì± Offline-First PWA</h4>
          <ul>
            <li><strong>Works Offline</strong>: Edit notes without connectivity</li>
            <li><strong>Auto-Sync</strong>: Changes sync when you're back online</li>
            <li><strong>Conflict Resolution</strong>: Detects and helps resolve conflicts</li>
            <li><strong>Native Feel</strong>: Install as desktop or mobile app</li>
          </ul>
        </div>

        <div class="modal-section">
          <h4>üîó Bi-Directional Integrations</h4>
          <ul>
            <li><strong>Google Calendar</strong>: View and inject agendas into journal entries</li>
            <li><strong>Gmail</strong>: See unread counts, read emails</li>
            <li><strong>Google Tasks</strong>: Manage tasks alongside notes</li>
            <li><strong>File System</strong>: Syncs with actual markdown files on disk</li>
          </ul>
        </div>

        <div class="modal-section">
          <h4>‚úèÔ∏è Live Editing & Preview</h4>
          <ul>
            <li><strong>Rich Editor</strong>: Syntax highlighting, vim/emacs keybindings</li>
            <li><strong>Wiki-Links</strong>: [[link to files]], backlinks panel</li>
            <li><strong>Multi-Buffer</strong>: Open multiple files in tabs</li>
            <li><strong>Auto-Save</strong>: Changes save as you type</li>
          </ul>
        </div>

        <div class="modal-section">
          <h4>üåê Web-Based Accessibility</h4>
          <ul>
            <li><strong>Access Anywhere</strong>: Any device with a browser</li>
            <li><strong>Cross-Platform</strong>: Windows, Mac, Linux, iOS, Android</li>
            <li><strong>Mobile-Responsive</strong>: Optimized for phones and tablets</li>
            <li><strong>Low Storage</strong>: Server holds the vault, clients cache as needed</li>
          </ul>
        </div>

        <h3 style="margin-top: 2rem;">Keyboard Shortcuts</h3>
        <table style="width: 100%; border-collapse: collapse; margin: 1rem 0;">
          <tr style="border-bottom: 1px solid #444;">
            <td style="padding: 0.5rem;"><kbd>Ctrl+P</kbd> / <kbd>Cmd+P</kbd></td>
            <td style="padding: 0.5rem; color: #888;">Quick file switcher</td>
          </tr>
          <tr style="border-bottom: 1px solid #444;">
            <td style="padding: 0.5rem;"><kbd>Ctrl+S</kbd> / <kbd>Cmd+S</kbd></td>
            <td style="padding: 0.5rem; color: #888;">Save file</td>
          </tr>
          <tr style="border-bottom: 1px solid #444;">
            <td style="padding: 0.5rem;"><kbd>Ctrl+B</kbd> / <kbd>Cmd+B</kbd></td>
            <td style="padding: 0.5rem; color: #888;">Toggle sidebar</td>
          </tr>
          <tr style="border-bottom: 1px solid #444;">
            <td style="padding: 0.5rem;"><kbd>Ctrl+N</kbd> / <kbd>Cmd+N</kbd></td>
            <td style="padding: 0.5rem; color: #888;">New file</td>
          </tr>
          <tr style="border-bottom: 1px solid #444;">
            <td style="padding: 0.5rem;"><kbd>Ctrl+K</kbd> / <kbd>Cmd+K</kbd></td>
            <td style="padding: 0.5rem; color: #888;">Insert link</td>
          </tr>
          <tr>
            <td style="padding: 0.5rem;"><kbd>Alt+Left/Right</kbd></td>
            <td style="padding: 0.5rem; color: #888;">Navigate history</td>
          </tr>
        </table>

        <div class="modal-info-box">
          <p>
            <strong>Learn More:</strong> See the 
            <a href="https://github.com/c25l/H3LPeR" target="_blank">GitHub repository</a> 
            for full documentation and setup instructions.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Pass data to JS -->
  <script>
    window.APP_DATA = {
      currentFile: <%- currentFile ? JSON.stringify(currentFile) : 'null' %>,
      fileTree: <%- JSON.stringify(files) %>
    };
  </script>

  <script src="/js/app.js" type="module"></script>
</body>
</html>
