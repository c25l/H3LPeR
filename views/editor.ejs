<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H3LPeR</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#569cd6">
  <meta name="description" content="Personal journal with calendar, tasks, and email integration">
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="H3LPeR">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/helper-tabs.css">
  <!-- Tiptap Editor (bundled with dependencies) -->
  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>
<body>
  <!-- Google Auth Status Banner -->
  <div id="google-auth-banner" class="auth-banner hidden">
    <span id="auth-banner-message"></span>
    <button onclick="window.location.href='/google-setup'" class="btn btn-secondary btn-sm">Re-authenticate</button>
    <button onclick="document.getElementById('google-auth-banner').classList.add('hidden')" class="btn btn-icon btn-sm">&times;</button>
  </div>

  <!-- Tab Navigation -->
  <nav class="tab-nav">
    <button class="tab-btn" data-tab="calendar" id="calendar-tab-btn">Calendar</button>
    <button class="tab-btn" data-tab="journal">Journal</button>
    <button class="tab-btn active" data-tab="weather" id="weather-tab-btn">Weather</button>
    <button class="tab-btn" data-tab="news" id="news-tab-btn">News</button>
    <button class="tab-btn" data-tab="research" id="research-tab-btn">Research</button>
    <div class="tab-nav-spacer"></div>
    <a href="https://mail.google.com" target="_blank" class="btn btn-link btn-sm email-indicator" id="email-indicator" title="Gmail" style="margin-right: 0.5rem;">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
        <polyline points="22,6 12,13 2,6"></polyline>
      </svg>
      <span id="unread-count" class="unread-badge hidden">0</span>
    </a>
    <a href="/google-setup" class="btn btn-link btn-sm" style="margin-right: 1rem;" title="Google Integration">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
    </a>
  </nav>

  <!-- Journal Tab -->
  <div class="tab-content" id="journal-tab">
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="app-sidebar">
      <div class="sidebar-icon-rail" id="icon-rail">
        <div class="icon-rail-top" id="icon-rail-top"></div>
        <div class="icon-rail-bottom" id="icon-rail-bottom">
          <button class="icon-rail-btn" id="sidebar-new-file-btn" title="New File">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </button>
          <button class="icon-rail-btn" id="sidebar-collapse-btn" title="Collapse Sidebar (Ctrl+B)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <line x1="9" y1="3" x2="9" y2="21"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="sidebar-panel-area" id="sidebar-panels">
        <div class="sidebar-panel-header" id="sidebar-panel-header">
          <span class="sidebar-panel-title" id="sidebar-panel-title"></span>
        </div>
        <div class="sidebar-panel-container" id="sidebar-panel-container"></div>
        <div class="sidebar-footer">
          <div id="sync-status" class="sync-status">
            <span class="sync-indicator"></span>
            <span id="sync-text">Syncing...</span>
          </div>
          <a href="/api/logout" class="btn btn-link">Logout</a>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Editor Header -->
      <header class="editor-header">
        <div class="file-info">
          <button id="mobile-sidebar-toggle" class="btn btn-icon mobile-only" title="Toggle Sidebar">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="3" y1="12" x2="21" y2="12"></line>
              <line x1="3" y1="6" x2="21" y2="6"></line>
              <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
          </button>
          <div class="buffer-menu-container">
            <button id="buffer-menu-btn" class="btn btn-icon" onclick="toggleBufferMenu()" title="Buffer menu (Ctrl+B)">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
              </svg>
            </button>
            <div id="buffer-menu" class="buffer-menu hidden">
              <div class="buffer-menu-section">
                <div class="buffer-menu-section-title">Special Buffers</div>
                <div class="buffer-menu-item" data-buffer-type="today" onclick="openSpecialBuffer('today')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                  Today's Note
                </div>
                <div class="buffer-menu-item" data-buffer-type="calendar" onclick="openSpecialBuffer('calendar')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                  Calendar View
                </div>
              </div>
              <div class="buffer-menu-section">
                <div class="buffer-menu-section-title">Root Files</div>
                <div id="buffer-menu-root-files" class="buffer-menu-items">
                  <div class="buffer-menu-loading">Loading...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="file-menu-container">
            <button id="file-menu-btn" class="btn btn-icon" onclick="toggleFileMenu()" title="File menu">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
                <polyline points="13 2 13 9 20 9"></polyline>
              </svg>
            </button>
            <div id="file-menu" class="file-menu hidden">
              <div class="file-menu-item" id="file-menu-save-as" onclick="saveBufferAsFile()">Save As...</div>
              <div class="file-menu-item" id="file-menu-rename" onclick="renameCurrentFile()">Rename</div>
              <div class="file-menu-item danger" id="file-menu-delete" onclick="deleteCurrentFile()">Delete</div>
            </div>
          </div>
          <div class="file-path" id="current-file-path">
            <%= currentFile ? currentFile.path : 'Select a file' %>
          </div>
        </div>
        <div class="editor-actions">
          <button id="nav-back-btn" class="btn btn-icon" onclick="navigateBack()" title="Go back" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <button id="nav-forward-btn" class="btn btn-icon" onclick="navigateForward()" title="Go forward" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
          <div class="editor-separator"></div>
          <button id="undo-btn" class="btn btn-icon" onclick="editorUndo()" title="Undo (Ctrl+Z)" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="1 4 1 10 7 10"></polyline>
              <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
            </svg>
          </button>
          <button id="redo-btn" class="btn btn-icon" onclick="editorRedo()" title="Redo (Ctrl+Shift+Z)" disabled>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
          </button>
          <div class="editor-separator"></div>
          <button id="add-agenda-btn" class="btn btn-secondary" onclick="addTodayAgendaFromCalendar()" title="Add today's agenda">Add Agenda</button>
          <span id="save-status"></span>
        </div>
      </header>

      <div class="buffer-tabs" id="buffer-tabs"></div>

      <!-- Editor -->
      <div class="editor-container">
        <div id="editor"></div>
      </div>

      <!-- Backlinks Panel (collapsible) -->
      <div class="backlinks-panel collapsed" id="backlinks-panel">
        <div class="backlinks-header" onclick="toggleBacklinks()">
          <span class="backlinks-toggle">▶</span>
          <h3>Backlinks</h3>
          <span class="backlinks-count" id="backlinks-count"></span>
        </div>
        <div class="backlinks-content" id="backlinks-list"></div>
      </div>
    </main>

    <!-- Quick Switcher Modal -->
    <div id="quick-switcher" class="modal hidden">
      <div class="modal-content">
        <input type="text" id="switcher-input" placeholder="Type to search files...">
        <div id="switcher-results"></div>
      </div>
    </div>

    <!-- New File Modal -->
    <div id="new-file-modal" class="modal hidden">
      <div class="modal-content">
        <h3>New File</h3>
        <input type="text" id="new-file-name" placeholder="filename.md">
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeNewFileModal()">Cancel</button>
          <button class="btn btn-primary" onclick="createNewFile()">Create</button>
        </div>
      </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflict-modal" class="modal hidden">
      <div class="modal-content conflict-modal">
        <h3>⚠️ Sync Conflict Detected</h3>
        <p>This file was modified both locally and on the server. Choose which version to keep:</p>
        <div class="conflict-versions">
          <div class="conflict-version">
            <h4>Your Local Version</h4>
            <pre id="conflict-local"></pre>
            <button class="btn btn-primary" onclick="resolveConflict('local')">Keep Local</button>
          </div>
          <div class="conflict-version">
            <h4>Server Version</h4>
            <pre id="conflict-server"></pre>
            <button class="btn btn-primary" onclick="resolveConflict('server')">Keep Server</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <!-- End Journal Tab -->

  <!-- Calendar Tab -->
  <div class="tab-content" id="calendar-tab">
    <div class="calendar-tab-container">
      <div class="calendar-tab-header">
        <h2>Calendar & Tasks</h2>
        <div class="calendar-controls">
          <button id="refresh-calendar" class="btn btn-secondary" title="Refresh">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Refresh
          </button>
          <button id="calendar-settings" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m0-12l4 4m-4 4l4 4m-8-8l-4-4m4 4l-4 4"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="calendar-tab-main">
        <aside class="calendar-sidebar">
          <div id="calendar-selector-panel">
            <h3>My Calendars</h3>
            <div id="calendar-list" class="calendar-list"></div>
          </div>
          <div id="tasks-panel" class="tasks-panel"></div>
        </aside>
        <div id="calendar-view" class="calendar-view"></div>
      </div>
    </div>
  </div>
  <!-- End Calendar Tab -->

  <!-- Weather Tab -->
  <div class="tab-content active" id="weather-tab">
    <div class="helper-tab-container">
      <div class="helper-tab-header">
        <h2>Weather & Space Weather</h2>
        <div class="helper-controls">
          <button id="refresh-weather" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>
      <div class="helper-tab-content" id="weather-content">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>
  <!-- End Weather Tab -->

  <!-- News Tab -->
  <div class="tab-content" id="news-tab">
    <div class="helper-tab-container">
      <div class="helper-tab-header">
        <h2>News & Stories</h2>
        <div class="helper-controls">
          <button id="refresh-news" class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"></polyline>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            Refresh
          </button>
        </div>
      </div>
      <div class="helper-tab-content" id="news-stories">
        <div class="loading-spinner"></div>
      </div>
      <div class="stocks-ticker" id="stocks-ticker"></div>
    </div>
  </div>
  <!-- End News Tab -->

  <!-- Research Tab -->
  <div class="tab-content" id="research-tab">
    <div class="helper-tab-container">
      <div class="helper-tab-header">
        <h2>Research Papers</h2>
        <div class="helper-controls">
          <select id="research-date">
            <option value="">Today</option>
          </select>
        </div>
      </div>
      <div class="helper-tab-content" id="research-content">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>
  <!-- End Research Tab -->

  <!-- Pass data to JS -->
  <script>
    window.APP_DATA = {
      currentFile: <%- currentFile ? JSON.stringify(currentFile) : 'null' %>,
      fileTree: <%- JSON.stringify(files) %>
    };
  </script>

  <script src="/js/app.js" type="module"></script>
</body>
</html>
