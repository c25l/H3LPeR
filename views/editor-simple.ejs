<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Public Whiteboard - H3LPeR</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#569cd6">
  <meta name="description" content="Public whiteboard with weather, news, and research">
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="H3LPeR">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/helper-tabs.css">
</head>
<body>
  <!-- Main App Container -->
  <div class="app-container no-sidebar">
    <!-- Header -->
    <header class="app-header">
      <div class="app-header-left">
        <span class="app-title">H3LPeR - Public Whiteboard</span>
      </div>
      <div class="app-header-right">
        <div id="sync-status" class="sync-status inline">
          <span class="sync-indicator"></span>
          <span id="sync-text">Synced</span>
        </div>
      </div>
    </header>

    <!-- Unified Buffer Tabs -->
    <div class="buffer-tabs" id="buffer-tabs">
      <div class="buffer-tab active" data-tab="whiteboard">
        <span class="buffer-tab-label">Whiteboard</span>
      </div>
      <div class="buffer-tab" data-tab="weather">
        <span class="buffer-tab-label">Weather</span>
      </div>
      <div class="buffer-tab" data-tab="news">
        <span class="buffer-tab-label">News</span>
      </div>
      <div class="buffer-tab" data-tab="research">
        <span class="buffer-tab-label">Research</span>
      </div>
      <div class="buffer-tab" data-tab="astronomy">
        <span class="buffer-tab-label">Stars</span>
      </div>
    </div>

    <!-- Main Content -->
    <main class="main-content full-width">
      <!-- Whiteboard Content -->
      <div id="whiteboard-content-container" class="special-content-container">
        <div class="editor-header" style="padding: 8px 16px; border-bottom: 1px solid #374151;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 16px;">Public Whiteboard</h2>
            <div>
              <button id="save-whiteboard" class="btn btn-secondary" style="margin-right: 8px;">Save</button>
              <span id="save-status" style="color: #9ca3af;"></span>
            </div>
          </div>
        </div>
        <div class="editor-container">
          <textarea id="whiteboard-editor" style="width: 100%; height: calc(100vh - 180px); padding: 16px; background: #1f2937; color: #e5e7eb; border: none; font-family: 'Courier New', monospace; font-size: 14px; resize: none;"><%= whiteboard.content %></textarea>
        </div>
      </div>

      <!-- Weather Content -->
      <div id="weather-content-container" class="special-content-container hidden">
        <div class="helper-tab-container">
          <div class="helper-tab-header">
            <h2>Weather & Space Weather</h2>
            <div class="helper-controls">
              <button id="refresh-weather" class="btn btn-secondary">Refresh</button>
            </div>
          </div>
          <div class="helper-tab-content" id="weather-content">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- News Content -->
      <div id="news-content-container" class="special-content-container hidden">
        <div class="helper-tab-container">
          <div class="helper-tab-header">
            <h2>News</h2>
            <div class="helper-controls">
              <button id="refresh-news" class="btn btn-secondary">Refresh</button>
            </div>
          </div>
          <div class="helper-tab-content" id="news-content">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Research Content -->
      <div id="research-content-container" class="special-content-container hidden">
        <div class="helper-tab-container">
          <div class="helper-tab-header">
            <h2>Research Papers</h2>
            <div class="helper-controls">
              <button id="refresh-research" class="btn btn-secondary">Refresh</button>
            </div>
          </div>
          <div class="helper-tab-content" id="research-content">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Astronomy Content -->
      <div id="astronomy-content-container" class="special-content-container hidden">
        <div class="helper-tab-container">
          <div class="helper-tab-header">
            <h2>Star Chart</h2>
            <div class="helper-controls">
              <button id="refresh-astronomy" class="btn btn-secondary">Refresh</button>
            </div>
          </div>
          <div class="helper-tab-content">
            <div id="star-chart-container" style="height: calc(100vh - 180px);"></div>
            <div id="orrery-container" style="height: 280px; margin-top: 20px;"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Simple scripts -->
  <script>
    // Tab switching
    document.querySelectorAll('.buffer-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.buffer-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Show/hide content
        document.querySelectorAll('.special-content-container').forEach(c => c.classList.add('hidden'));
        document.getElementById(`${tabName}-content-container`).classList.remove('hidden');
        
        // Load content if needed
        if (tabName === 'weather') loadWeather();
        if (tabName === 'news') loadNews();
        if (tabName === 'research') loadResearch();
        if (tabName === 'astronomy') loadAstronomy();
      });
    });

    // Whiteboard auto-save
    let saveTimeout;
    const editor = document.getElementById('whiteboard-editor');
    const saveBtn = document.getElementById('save-whiteboard');
    const saveStatus = document.getElementById('save-status');
    
    editor.addEventListener('input', () => {
      saveStatus.textContent = 'Unsaved changes...';
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(saveWhiteboard, 2000);
    });
    
    saveBtn.addEventListener('click', saveWhiteboard);
    
    async function saveWhiteboard() {
      try {
        const response = await fetch('/api/whiteboard', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content: editor.value })
        });
        const data = await response.json();
        if (data.success) {
          saveStatus.textContent = 'Saved';
          setTimeout(() => saveStatus.textContent = '', 2000);
        }
      } catch (error) {
        saveStatus.textContent = 'Error saving';
        console.error('Save error:', error);
      }
    }

    // Load helper content functions
    async function loadWeather() {
      const container = document.getElementById('weather-content');
      if (container.innerHTML.includes('loading-spinner')) {
        try {
          // Get user location
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const response = await fetch(`/api/helper/weather?lat=${lat}&lon=${lon}`);
              const data = await response.json();
              container.innerHTML = formatWeather(data);
            }, () => {
              container.innerHTML = '<p>Location permission denied. Weather requires location access.</p>';
            });
          }
        } catch (error) {
          container.innerHTML = '<p>Error loading weather</p>';
        }
      }
    }

    async function loadNews() {
      const container = document.getElementById('news-content');
      if (container.innerHTML.includes('loading-spinner')) {
        try {
          const response = await fetch('/api/helper/news');
          const data = await response.json();
          container.innerHTML = formatNews(data);
        } catch (error) {
          container.innerHTML = '<p>Error loading news</p>';
        }
      }
    }

    async function loadResearch() {
      const container = document.getElementById('research-content');
      if (container.innerHTML.includes('loading-spinner')) {
        try {
          const response = await fetch('/api/helper/research');
          const data = await response.json();
          container.innerHTML = formatResearch(data);
        } catch (error) {
          container.innerHTML = '<p>Error loading research</p>';
        }
      }
    }

    async function loadAstronomy() {
      const container = document.getElementById('star-chart-container');
      if (!container.hasChildNodes()) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            // Load star chart module and initialize
            import('/js/star-chart.js').then(module => {
              module.initStarChart('star-chart-container', { lat, lon });
            });
          });
        }
      }
    }

    // Formatting helpers
    function formatWeather(data) {
      return `<div class="weather-info">
        <h3>${data.location}</h3>
        <p><strong>Temperature:</strong> ${data.temperature}Â°C</p>
        <p><strong>Conditions:</strong> ${data.conditions}</p>
      </div>`;
    }

    function formatNews(data) {
      if (!data.groups) return '<p>No news available</p>';
      return data.groups.map(group => `
        <div class="news-group">
          <h3>${group.topic || 'News'}</h3>
          ${group.articles.map(article => `
            <div class="news-article">
              <a href="${article.link}" target="_blank">${article.title}</a>
              <p>${article.pubDate}</p>
            </div>
          `).join('')}
        </div>
      `).join('');
    }

    function formatResearch(data) {
      if (!data.papers) return '<p>No papers available</p>';
      return data.papers.map(paper => `
        <div class="research-paper">
          <h3><a href="${paper.link}" target="_blank">${paper.title}</a></h3>
          <p><strong>Authors:</strong> ${paper.authors.join(', ')}</p>
          <p>${paper.summary}</p>
        </div>
      `).join('');
    }

    // Refresh buttons
    document.getElementById('refresh-weather').addEventListener('click', () => {
      document.getElementById('weather-content').innerHTML = '<div class="loading-spinner"></div>';
      loadWeather();
    });
    
    document.getElementById('refresh-news').addEventListener('click', () => {
      document.getElementById('news-content').innerHTML = '<div class="loading-spinner"></div>';
      loadNews();
    });
    
    document.getElementById('refresh-research').addEventListener('click', () => {
      document.getElementById('research-content').innerHTML = '<div class="loading-spinner"></div>';
      loadResearch();
    });
    
    document.getElementById('refresh-astronomy').addEventListener('click', () => {
      document.getElementById('star-chart-container').innerHTML = '';
      loadAstronomy();
    });
  </script>
</body>
</html>
